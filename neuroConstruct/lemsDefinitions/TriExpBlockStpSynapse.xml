<Lems xmlns="http://www.neuroml.org/lems/0.7"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.neuroml.org/lems/0.7
			  ../../LEMS/Schemas/LEMS/LEMS_v0.7.xsd">

  <Include file="NeuroMLCoreDimensions.xml"/>
  <Include file="Synapses.xml"/>

    <ComponentType name="TriExpBlockStpSynapse"
       extends="baseSynapse"
       description="Blocking synapse with short term plasticity and triexponential basic waveform (one rise time, two decay times).">
      <Parameter name="erev" dimension="voltage" description="Reversal potential of the synapse"/>
      <Exposure name="g" dimension="conductance" description="Time varying conductance through the synapse"/>
      <Child name="plasticityMechanism" type="basePlasticityMechanism"/>
      <Child name="blockMechanism" type="baseBlock"/>

      <EventPort name="relay" direction="out" description="Used to relay incoming spikes to child plasticity mechanism"/>

      <!-- DIRECT -->
      <!-- waveform shape parameters -->
      <Parameter name="directAmp1" dimension="conductance"/>
      <Parameter name="directAmp2" dimension="conductance"/>
      <Parameter name="directTauRise" dimension="time"/>
      <Parameter name="directTauDecay1" dimension="time"/>
      <Parameter name="directTauDecay2" dimension="time"/>

      <Dynamics>
	<DerivedVariable name="blockFactor" dimension="none" select="blockMechanism/scaling" />
	<DerivedVariable name="g" dimension="conductance" exposure="g" value="blockFactor * (directAmp1 * (directB1 - directA1) + directAmp2 * (directB2 - directA2))" />
	<DerivedVariable name="i" exposure="i" dimension="current" value="g * (erev - v)" />

	<!-- DIRECT -->
	<StateVariable name="directA1" dimension="none"/>
	<StateVariable name="directA2" dimension="none"/>
	<StateVariable name="directB1" dimension="none"/>
	<StateVariable name="directB2" dimension="none"/>

	<DerivedVariable name="directPeakTime1" dimension="time" value="(directTauRise * directTauDecay1)/(directTauDecay1 - directTauRise) * ln(directTauDecay1 / directTauRise)" />
	<DerivedVariable name="directPeakTime2" dimension="time" value="(directTauRise * directTauDecay2)/(directTauDecay2 - directTauRise) * ln(directTauDecay2 / directTauRise)" />
	<DerivedVariable name="directFactor1" dimension="none" value="1 / (-exp(-directPeakTime1 / directTauRise) + exp(-directPeakTime1 / directTauDecay1))" />
	<DerivedVariable name="directFactor2" dimension="none" value="1 / (-exp(-directPeakTime2 / directTauRise) + exp(-directPeakTime2 / directTauDecay2))" />

	<TimeDerivative variable="directA1" value="-directA1 / directTauRise" />
	<TimeDerivative variable="directA2" value="-directA2 / directTauRise" />
	<TimeDerivative variable="directB1" value="-directB1 / directTauDecay1" />
	<TimeDerivative variable="directB2" value="-directB2 / directTauDecay2" />

	<DerivedVariable name="directPlasticityFactor" dimension="none" select="plasticityMechanism/plasticityFactor" />

	<OnStart>
	  <!-- DIRECT -->
	  <StateAssignment variable="directA1" value="0" />
	  <StateAssignment variable="directA2" value="0" />
	  <StateAssignment variable="directB1" value="0" />
	  <StateAssignment variable="directB2" value="0" />
	</OnStart>

	<OnEvent port="in">
	  <!-- DIRECT -->
	  <StateAssignment variable="directA1" value="directA1 + directPlasticityFactor * directFactor1" />
	  <StateAssignment variable="directA2" value="directA2 + directPlasticityFactor * directFactor2" />
	  <StateAssignment variable="directB1" value="directB1 + directPlasticityFactor * directFactor1" />
	  <StateAssignment variable="directB2" value="directB2 + directPlasticityFactor * directFactor2" />
	  <EventOut port="relay"/>
	</OnEvent>

      </Dynamics>
    </ComponentType>

</Lems>
